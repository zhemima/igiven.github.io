<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.igiven.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="In this post I describe how to run Quartz.NET jobs using an ASP.NET Core hosted service. I show how to create a simple IJob, a custom IJobFactory, and a QuartzHostedService that runs jobs while your a">
<meta property="og:type" content="article">
<meta property="og:title" content="Creating a Quartz.NET hosted service with ASP.NET Core">
<meta property="og:url" content="http://www.igiven.com/dotnet-2019-11-05-quartz/index.html">
<meta property="og:site_name" content="IGiven">
<meta property="og:description" content="In this post I describe how to run Quartz.NET jobs using an ASP.NET Core hosted service. I show how to create a simple IJob, a custom IJobFactory, and a QuartzHostedService that runs jobs while your a">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.igiven.com/assets/images/2019-11-05-quartz/icons-link.svg">
<meta property="og:image" content="https://andrewlock.net/assets/img/icons-link.svg">
<meta property="og:image" content="https://andrewlock.net/assets/img/icons-link.svg">
<meta property="og:image" content="https://andrewlock.net/assets/img/icons-link.svg">
<meta property="og:image" content="https://andrewlock.net/assets/img/icons-link.svg">
<meta property="og:image" content="https://andrewlock.net/assets/img/icons-link.svg">
<meta property="og:image" content="http://www.igiven.com/assets/images/2019-11-05-quartz/quartz_service.png">
<meta property="og:image" content="https://andrewlock.net/assets/img/icons-link.svg">
<meta property="og:image" content="https://andrewlock.net/assets/img/icons-link.svg">
<meta property="article:published_time" content="2019-11-05T00:00:00.000Z">
<meta property="article:modified_time" content="2021-06-26T09:22:11.017Z">
<meta property="article:author" content="zhepama">
<meta property="article:tag" content="NETCORE">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Win">
<meta property="article:tag" content="C">
<meta property="article:tag" content="GitHub">
<meta property="article:tag" content="sync">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.igiven.com/assets/images/2019-11-05-quartz/icons-link.svg">

<link rel="canonical" href="http://www.igiven.com/dotnet-2019-11-05-quartz/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Creating a Quartz.NET hosted service with ASP.NET Core | IGiven</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="IGiven" type="application/atom+xml">
<link rel="alternate" href="/rss2.xml" title="IGiven" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">IGiven</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">李九仙的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">139</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">4</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">32</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-留言">

    <a href="/guestbook/" rel="section"><i class="fa fa-sticky-note fa-fw"></i>留言</a>

  </li>
        <li class="menu-item menu-item-rss">

    <a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>RSS</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.igiven.com/dotnet-2019-11-05-quartz/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://secure.gravatar.com/avatar/0930091f05ac4d1044c02dbd3d619cfe?s=80&d=identicon&r=g">
      <meta itemprop="name" content="zhepama">
      <meta itemprop="description" content="一个不专业的程序员,写着专业的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IGiven">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Creating a Quartz.NET hosted service with ASP.NET Core<a href="https://github.com/zhepama/igiven.github.io/edit/master/source/_posts/dotnet/2019-11-05-quartz.md" class="post-edit-link" title="编辑" rel="noopener" target="_blank"><i class="fa fa-pencil-alt"></i></a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-05 08:00:00" itemprop="dateCreated datePublished" datetime="2019-11-05T08:00:00+08:00">2019-11-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-26 17:22:11" itemprop="dateModified" datetime="2021-06-26T17:22:11+08:00">2021-06-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dotnet/" itemprop="url" rel="index"><span itemprop="name">dotnet</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>In this post I describe how to run Quartz.NET jobs using an <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services?view=aspnetcore-2.2" target="_blank" rel="noopener">ASP.NET Core hosted service</a>. I show how to create a simple <code>IJob</code>, a custom <code>IJobFactory</code>, and a <code>QuartzHostedService</code> that runs jobs while your application is running. I’ll also touch on some of the issues to aware of, namely of using scoped services inside singleton classes.</p>
<h2 id="Introduction-what-is-Quartz-NET"><a href="#Introduction-what-is-Quartz-NET" class="headerlink" title="Introduction - what is Quartz.NET?"></a>Introduction - what is Quartz.NET?<a href="https://andrewlock.net/creating-a-quartz-net-hosted-service-with-asp-net-core/#introduction-what-is-quartz-net-" target="_blank" rel="noopener"><img src="../../assets/images/2019-11-05-quartz/icons-link.svg" alt="img"></a></h2><p>As per <a href="https://www.quartz-scheduler.net/" target="_blank" rel="noopener">their website</a>:</p>
<blockquote>
<p>Quartz.NET is a full-featured, open source job scheduling system that can be used from smallest apps to large scale enterprise systems.</p>
</blockquote>
<p>It’s an old staple of many ASP.NET developers, used as a way of running background tasks on a timer, in a reliable, clustered, way. Using Quartz.NET with ASP.NET Core is pretty similar - Quartz.NET supports .NET Standard 2.0, so you can easily use it in your applications.</p>
<p>Quartz.NET has two main concepts:</p>
<ul>
<li>A <strong>job</strong>. This is the background tasks that you want to run on some sort of schedule.</li>
<li>A <strong>scheduler</strong>. This is responsible for running jobs based on triggers, on a time-based schedule.</li>
</ul>
<p>ASP.NET Core has good support for running “background tasks” via way of <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services" target="_blank" rel="noopener">hosted services</a>. Hosted services are started when your ASP.NET Core app starts, and run in the background for the lifetime of the application. By creating a Quartz.NET hosted service, you can use a standard ASP.NET Core application for running your tasks in the background.</p>
<blockquote>
<p>This sort of non-HTTP scenario is also possible with the “generic host”, <a href="https://andrewlock.net/the-asp-net-core-generic-host-namespace-clashes-and-extension-methods/" target="_blank" rel="noopener">but for various reasons</a> I generally don’t use those at the moment. This should hopefully improve in ASP.NET Core 3.0 with the extra investment going into these non-HTTP scenarios.</p>
</blockquote>
<p>While it’s possible to create <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services?view=aspnetcore-2.2#timed-background-tasks" target="_blank" rel="noopener">a “timed” background service</a>, (that runs a tasks every 10 minutes, for example), Quartz.NET provides a far more robust solution. You can ensure tasks only run at specific times of the day (e.g. 2:30am), or only on specific days, or any combination by using a <a href="https://www.quartz-scheduler.net/documentation/quartz-3.x/tutorial/crontriggers.html" target="_blank" rel="noopener">Cron trigger</a>. It also allows you to run multiple instances of your application in a clustered fashion, so that only a single instance can run a given task at any one time.</p>
<p>In this post I’ll show the basics of creating a Quartz.NET job and scheduling it to run on a timer in a hosted service.</p>
<h2 id="Installing-Quartz-NET"><a href="#Installing-Quartz-NET" class="headerlink" title="Installing Quartz.NET"></a>Installing Quartz.NET<a href="https://andrewlock.net/creating-a-quartz-net-hosted-service-with-asp-net-core/#installing-quartz-net" target="_blank" rel="noopener"><img src="https://andrewlock.net/assets/img/icons-link.svg" alt="img"></a></h2><p>Quartz.NET is a .NET Standard 2.0 NuGet package, so it should be easy to install in your application. For this test I created an ASP.NET Core project and chose the Empty template. You can install the Quartz.NET package using <code>dotnet add package Quartz</code>. If you view the <em>.csproj</em> for the project, it should look something like this:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">Sdk</span>=<span class="string">"Microsoft.NET.Sdk.Web"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TargetFramework</span>&gt;</span>netcoreapp2.2<span class="tag">&lt;/<span class="name">TargetFramework</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AspNetCoreHostingModel</span>&gt;</span>InProcess<span class="tag">&lt;/<span class="name">AspNetCoreHostingModel</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.AspNetCore.App"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Quartz"</span> <span class="attr">Version</span>=<span class="string">"3.0.7"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Creating-an-IJob"><a href="#Creating-an-IJob" class="headerlink" title="Creating an IJob"></a>Creating an IJob<a href="https://andrewlock.net/creating-a-quartz-net-hosted-service-with-asp-net-core/#creating-an-ijob" target="_blank" rel="noopener"><img src="https://andrewlock.net/assets/img/icons-link.svg" alt="img"></a></h2><p>For the actual background work we are scheduling, we’re just going to use a “hello world” implementation that writes to an <code>ILogger&lt;&gt;</code> (and hence to the console). You should implement the Quartz interface <code>IJob</code> which contains a single asynchronous <code>Execute()</code> method. Note that we’re using dependency injection here to inject the logger into the constructor.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> Quartz;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line">[<span class="meta">DisallowConcurrentExecution</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HelloWorldJob</span> : <span class="title">IJob</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;HelloWorldJob&gt; _logger;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloWorldJob</span>(<span class="params">ILogger&lt;HelloWorldJob&gt; logger</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">Execute</span>(<span class="params">IJobExecutionContext context</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _logger.LogInformation(<span class="string">"Hello world!"</span>);</span><br><span class="line">        <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I also decorated the job with the <code>[DisallowConcurrentExecution]</code> attribute. This attribute <a href="https://www.quartz-scheduler.net/documentation/quartz-3.x/tutorial/more-about-jobs.html#job-state-and-concurrency" target="_blank" rel="noopener">prevents Quartz.NET from trying to run the same job concurrently</a>.</p>
<h2 id="Creating-an-IJobFactory"><a href="#Creating-an-IJobFactory" class="headerlink" title="Creating an IJobFactory"></a>Creating an IJobFactory<a href="https://andrewlock.net/creating-a-quartz-net-hosted-service-with-asp-net-core/#creating-an-ijobfactory" target="_blank" rel="noopener"><img src="https://andrewlock.net/assets/img/icons-link.svg" alt="img"></a></h2><p>Next, we need to tell Quartz how it should create instances of <code>IJob</code>. By default, Quartz will try and “new-up” instances of the job using <code>Activator.CreateInstance</code>, effectively calling <code>new HelloWorldJob()</code>. Unfortunately, as we’re using constructor injection, that won’t work. Instead, we can provide a custom <code>IJobFactory</code> that hooks into the ASP.NET Core dependency injection container (<code>IServiceProvider</code>):</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> Quartz;</span><br><span class="line"><span class="keyword">using</span> Quartz.Spi;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SingletonJobFactory</span> : <span class="title">IJobFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IServiceProvider _serviceProvider;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SingletonJobFactory</span>(<span class="params">IServiceProvider serviceProvider</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _serviceProvider = serviceProvider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IJob <span class="title">NewJob</span>(<span class="params">TriggerFiredBundle bundle, IScheduler scheduler</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> _serviceProvider.GetRequiredService(bundle.JobDetail.JobType) <span class="keyword">as</span> IJob;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReturnJob</span>(<span class="params">IJob job</span>)</span> &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This factory takes an <code>IServiceProvider</code> in the constructor, and implements the <code>IJobFactory</code> interface. The important method is the <code>NewJob()</code> method, in which the factory has to return the <code>IJob</code> requested by the Quartz scheduler. In this implementation we delegate directly to the <code>IServiceProvider</code>, and let the DI container find the required instance. The cast to <code>IJob</code> at the end is required because the non-generic version of <code>GetRequiredService</code> returns an <code>object</code>.</p>
<p>The <code>ReturnJob</code> method is where the scheduler tries to return (i.e. destroy) a job that was created by the factory. Unfortunately, there’s no mechanism for doing so with the built-in <code>IServiceProvider</code>. We can’t create a new <code>IScopeService</code> that fits into the required Quartz API, so we’re stuck only being able to create singleton jobs.</p>
<blockquote>
<p>This is important. With the above implementation, it is only safe to create <code>IJob</code> implementations that are <strong>Singletons</strong> (or transient).</p>
</blockquote>
<h2 id="Configuring-the-Job"><a href="#Configuring-the-Job" class="headerlink" title="Configuring the Job"></a>Configuring the Job<a href="https://andrewlock.net/creating-a-quartz-net-hosted-service-with-asp-net-core/#configuring-the-job" target="_blank" rel="noopener"><img src="https://andrewlock.net/assets/img/icons-link.svg" alt="img"></a></h2><p>I’m only showing a single <code>IJob</code> implementation here, but we want the Quartz hosted service to be a generic implementation that works for any number of jobs. To help with that, we create a simple DTO called <code>JobSchedule</code> that we’ll use to define the timer schedule for a given job type:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JobSchedule</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobSchedule</span>(<span class="params">Type jobType, <span class="keyword">string</span> cronExpression</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        JobType = jobType;</span><br><span class="line">        CronExpression = cronExpression;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Type JobType &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> CronExpression &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>JobType</code> is the .NET type of the job (<code>HelloWorldJob</code> for our example), and <code>CronExpression</code> is a <a href="https://www.quartz-scheduler.net/documentation/quartz-3.x/tutorial/crontriggers.html" target="_blank" rel="noopener">Quartz.NET Cron expression</a>. Cron expressions allow complex timer scheduling so you can set rules like “fire every half hour between the hours of 8 am and 10 am, on the 5th and 20th of every month”. Just be sure to <a href="https://www.quartz-scheduler.net/documentation/quartz-3.x/tutorial/crontriggers.html" target="_blank" rel="noopener">check the documentation</a> for examples as not all Cron expressions used by different systems are interchangeable.</p>
<p>We’ll add the job to DI and configure its schedule in <code>Startup.ConfigureServices()</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Builder;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> Quartz;</span><br><span class="line"><span class="keyword">using</span> Quartz.Impl;</span><br><span class="line"><span class="keyword">using</span> Quartz.Spi;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Add Quartz services</span></span><br><span class="line">    services.AddSingleton&lt;IJobFactory, SingletonJobFactory&gt;();</span><br><span class="line">    services.AddSingleton&lt;ISchedulerFactory, StdSchedulerFactory&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add our job</span></span><br><span class="line">    services.AddSingleton&lt;HelloWorldJob&gt;();</span><br><span class="line">    services.AddSingleton(<span class="keyword">new</span> JobSchedule(</span><br><span class="line">        jobType: <span class="keyword">typeof</span>(HelloWorldJob),</span><br><span class="line">        cronExpression: <span class="string">"0/5 * * * * ?"</span>)); <span class="comment">// run every 5 seconds</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This code adds four things as singletons to the DI container:</p>
<ul>
<li>The <code>SingletonJobFactory</code> shown earlier, used for creating the job instances.</li>
<li>An implementation of <code>ISchedulerFactory</code>, the built-in <code>StdSchedulerFactory</code>, which handles scheduling and managing jobs</li>
<li>The <code>HelloWorldJob</code> job itself</li>
<li>An instance of <code>JobSchedule</code> for the <code>HelloWorldJob</code> with a Cron expression to run every 5 seconds.</li>
</ul>
<p>There’s only one piece missing now that brings them all together, the <code>QuartzHostedService</code>.</p>
<h2 id="Creating-the-QuartzHostedService"><a href="#Creating-the-QuartzHostedService" class="headerlink" title="Creating the QuartzHostedService"></a>Creating the QuartzHostedService<a href="https://andrewlock.net/creating-a-quartz-net-hosted-service-with-asp-net-core/#creating-the-quartzhostedservice" target="_blank" rel="noopener"><img src="https://andrewlock.net/assets/img/icons-link.svg" alt="img"></a></h2><p>The <code>QuartzHostedService</code> is an implementation of <code>IHostedService</code> that sets up the Quartz scheduler, and starts it running in the background. Due to the design of Quartz, we can implement <code>IHostedService</code> directly, instead of the <a href="https://docs.microsoft.com/en-us/dotnet/standard/microservices-architecture/multi-container-microservice-net-applications/background-tasks-with-ihostedservice" target="_blank" rel="noopener">more common approach of deriving from the base <code>BackgroundService</code> class</a>. The full code for the service is listed below, and I’ll discuss it afterwards.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Hosting;</span><br><span class="line"><span class="keyword">using</span> Quartz;</span><br><span class="line"><span class="keyword">using</span> Quartz.Spi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">QuartzHostedService</span> : <span class="title">IHostedService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ISchedulerFactory _schedulerFactory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IJobFactory _jobFactory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IEnumerable&lt;JobSchedule&gt; _jobSchedules;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">QuartzHostedService</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        ISchedulerFactory schedulerFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">        IJobFactory jobFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">        IEnumerable&lt;JobSchedule&gt; jobSchedules</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _schedulerFactory = schedulerFactory;</span><br><span class="line">        _jobSchedules = jobSchedules;</span><br><span class="line">        _jobFactory = jobFactory;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> IScheduler Scheduler &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">StartAsync</span>(<span class="params">CancellationToken cancellationToken</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Scheduler = <span class="keyword">await</span> _schedulerFactory.GetScheduler(cancellationToken);</span><br><span class="line">        Scheduler.JobFactory = _jobFactory;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> jobSchedule <span class="keyword">in</span> _jobSchedules)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> job = CreateJob(jobSchedule);</span><br><span class="line">            <span class="keyword">var</span> trigger = CreateTrigger(jobSchedule);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">await</span> Scheduler.ScheduleJob(job, trigger, cancellationToken);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> Scheduler.Start(cancellationToken);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">StopAsync</span>(<span class="params">CancellationToken cancellationToken</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">await</span> Scheduler?.Shutdown(cancellationToken);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IJobDetail <span class="title">CreateJob</span>(<span class="params">JobSchedule schedule</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> jobType = schedule.JobType;</span><br><span class="line">        <span class="keyword">return</span> JobBuilder</span><br><span class="line">            .Create(jobType)</span><br><span class="line">            .WithIdentity(jobType.FullName)</span><br><span class="line">            .WithDescription(jobType.Name)</span><br><span class="line">            .Build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ITrigger <span class="title">CreateTrigger</span>(<span class="params">JobSchedule schedule</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder</span><br><span class="line">            .Create()</span><br><span class="line">            .WithIdentity(<span class="string">$"<span class="subst">&#123;schedule.JobType.FullName&#125;</span>.trigger"</span>)</span><br><span class="line">            .WithCronSchedule(schedule.CronExpression)</span><br><span class="line">            .WithDescription(schedule.CronExpression)</span><br><span class="line">            .Build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>QuartzHostedService</code> has three dependencies: the <code>ISchedulerFactory</code> and <code>IJobFactory</code> we configured in <code>Startup</code>, and an <code>IEnumerable</code>. We only added a single <code>JobSchedule</code> to the DI container (for the <code>HelloWorldJob</code>), but if you register more job schedules with the DI container they’ll all be injected here.</p>
<p><code>StartAsync</code> is called when the application starts up and is where we configure Quartz. We start by creating an instance of <code>IScheduler</code>, assigning it to a property for use later, and setting the <code>JobFactory</code> for the scheduler to the injected instance:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">StartAsync</span>(<span class="params">CancellationToken cancellationToken</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Scheduler = <span class="keyword">await</span> _schedulerFactory.GetScheduler(cancellationToken);</span><br><span class="line">    Scheduler.JobFactory = _jobFactory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Next, we loop through the injected job schedules, and create a Quartz <code>IJobDetail</code> and <code>ITrigger</code> for each one using the <code>CreateJob</code> and <code>CreateTrigger</code> helper methods at the end of the class. If you don’t like how this part works, or need more control over the configuration, you can easily customise it by extending the <code>JobSchedule</code> DTO as you see fit.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">StartAsync</span>(<span class="params">CancellationToken cancellationToken</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> jobSchedule <span class="keyword">in</span> _jobSchedules)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> job = CreateJob(jobSchedule);</span><br><span class="line">        <span class="keyword">var</span> trigger = CreateTrigger(jobSchedule);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> Scheduler.ScheduleJob(job, trigger, cancellationToken);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IJobDetail <span class="title">CreateJob</span>(<span class="params">JobSchedule schedule</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> jobType = schedule.JobType;</span><br><span class="line">    <span class="keyword">return</span> JobBuilder</span><br><span class="line">        .Create(jobType)</span><br><span class="line">        .WithIdentity(jobType.FullName)</span><br><span class="line">        .WithDescription(jobType.Name)</span><br><span class="line">        .Build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ITrigger <span class="title">CreateTrigger</span>(<span class="params">JobSchedule schedule</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> TriggerBuilder</span><br><span class="line">        .Create()</span><br><span class="line">        .WithIdentity(<span class="string">$"<span class="subst">&#123;schedule.JobType.FullName&#125;</span>.trigger"</span>)</span><br><span class="line">        .WithCronSchedule(schedule.CronExpression)</span><br><span class="line">        .WithDescription(schedule.CronExpression)</span><br><span class="line">        .Build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Finally, once all the jobs are scheduled, you call <code>Scheduler.Start()</code> to actually start the Quartz.NET scheduler processing in the background. When the app shuts down, the framework will call <code>StopAsync()</code>, at which point you can call <code>Scheduler.Stop()</code> to safely shut down the scheduler process.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">StopAsync</span>(<span class="params">CancellationToken cancellationToken</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">await</span> Scheduler?.Shutdown(cancellationToken);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can register the hosted service using the <code>AddHostedService()</code> extension method in <code>Startup.ConfigureServices</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    services.AddHostedService&lt;QuartzHostedService&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If you run the application, you should see the background task running every 5 seconds and writing to the Console (or wherever you have logging configured)</p>
<p><img src="../../assets/images/2019-11-05-quartz/quartz_service.png" alt="Background service writing Hello World to console repeatedly"></p>
<h2 id="Using-scoped-services-in-jobs"><a href="#Using-scoped-services-in-jobs" class="headerlink" title="Using scoped services in jobs"></a>Using scoped services in jobs<a href="https://andrewlock.net/creating-a-quartz-net-hosted-service-with-asp-net-core/#using-scoped-services-in-jobs" target="_blank" rel="noopener"><img src="https://andrewlock.net/assets/img/icons-link.svg" alt="img"></a></h2><p>There’s one big problem with the implementation as described in this post: you can only create Singleton or Transient jobs. That means you can’t use any dependencies that are registered as Scoped services. For example, you can’t inject an EF Core <code>DatabaseContext</code> into your <code>IJob</code> implementation, as you’ll have a <a href="http://blog.ploeh.dk/2014/06/02/captive-dependency/" target="_blank" rel="noopener">captive dependency</a> problem.</p>
<p>Working around this isn’t a big issue: you can inject an <code>IServiceProvider</code> and create your own scope, <a href="https://andrewlock.net/the-dangers-and-gotchas-of-using-scoped-services-when-configuring-options-in-asp-net-core/#3-creating-a-new-scope-in-iconfigureoptions" target="_blank" rel="noopener">similar to the solution for a similar problem in a previous post</a>. For example, if you need to use a scoped service in your <code>HelloWorldJob</code>, you could use something like the following:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HelloWorldJob</span> : <span class="title">IJob</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Inject the DI provider</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IServiceProvider _provider;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloWorldJob</span>(<span class="params"> IServiceProvider provider</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _provider = provider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">Execute</span>(<span class="params">IJobExecutionContext context</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Create a new scope</span></span><br><span class="line">        <span class="keyword">using</span>(<span class="keyword">var</span> scope = _provider.CreateScope())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Resolve the Scoped service</span></span><br><span class="line">            <span class="keyword">var</span> service = scope.ServiceProvider.GetService&lt;IScopedService&gt;();</span><br><span class="line">            _logger.LogInformation(<span class="string">"Hello world!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This ensures a new scope is created every time the job runs, so you can retrieve (and dispose) scoped services inside the <code>IJob</code>. Unfortunately things do get a little messy. In the next post I’ll show a variation on this approach that is a little cleaner.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary<a href="https://andrewlock.net/creating-a-quartz-net-hosted-service-with-asp-net-core/#summary" target="_blank" rel="noopener"><img src="https://andrewlock.net/assets/img/icons-link.svg" alt="img"></a></h2><p>In this post I introduced Quartz.NET and showed how you could use it to schedule background jobs to run in ASP.NET Core using <code>IHostedService</code>. The example shown in this post is best for singleton or transient jobs, which isn’t ideal, as consuming scoped services is clumsy. In the next post, I’ll show a variation on this approach that makes using scoped services easier.</p>
<ul>
<li><a href="https://github.com/andrewlock/blog-examples/tree/master/QuartzHostedService" target="_blank" rel="noopener">Example source code for this post</a></li>
<li><a href="https://github.com/HangfireIO/Cronos" target="_blank" rel="noopener">https://github.com/HangfireIO/Cronos</a> </li>
<li><a href="https://github.com/HangfireIO/Hangfire" target="_blank" rel="noopener">https://github.com/HangfireIO/Hangfire</a> </li>
<li><a href="https://github.com/quartznet/quartznet" target="_blank" rel="noopener">https://github.com/quartznet/quartznet</a> </li>
</ul>
<h3 id="Hangfire-与quartz-net对比"><a href="#Hangfire-与quartz-net对比" class="headerlink" title="Hangfire 与quartz.net对比"></a>Hangfire 与quartz.net对比</h3><p>在项目没有引入Hangfire之前，一直使用的是Quartz.net。个人认为Quartz.net在定时任务处理方面优势如下：</p>
<ul>
<li>支持秒级单位的定时任务处理，但是Hangfire只能支持分钟及以上的定时任务处理</li>
</ul>
<p>原因在于Hangfire用的是开源的<a href="https://github.com/atifaziz/NCrontab" target="_blank" rel="noopener">NCrontab</a>组件，跟linux上的crontab指令相似。</p>
<ul>
<li>更加复杂的触发器，日历以及任务调度处理</li>
<li>可配置的定时任务</li>
</ul>
<p>但是为什么要换Hangfire? 很大的原因在于项目需要一个后台可监控的应用，不用每次都要从服务器拉取日志查看，在没有ELK的时候相当不方便。Hangfire控制面板不仅提供监控，也可以手动的触发执行定时任务。如果在定时任务处理方面没有很高的要求，比如一定要5s定时执行，Hangfire值得拥有。抛开这些，Hangfire优势太明显了：</p>
<ul>
<li>持久化保存任务、队列、统计信息</li>
<li>重试机制</li>
<li>多语言支持</li>
<li>支持任务取消</li>
<li>支持按指定<code>Job Queue</code>处理任务</li>
<li>服务器端工作线程可控，即job执行并发数控制</li>
<li>分布式部署，支持高可用</li>
<li>良好的扩展性，如支持IOC、Hangfire Dashboard授权控制、Asp.net Core、持久化存储等</li>
</ul>
<p>说了这么多的优点，我们可以有个案例，例如秒杀场景：用户下单-&gt;订单生成-&gt;扣减库存，Hangfire对于这种分布式的应用处理也是适用的，最后会给出实现。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/NETCORE/" rel="tag"># NETCORE</a>
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/Win/" rel="tag"># Win</a>
              <a href="/tags/C/" rel="tag"># C</a>
              <a href="/tags/GitHub/" rel="tag"># GitHub</a>
              <a href="/tags/sync/" rel="tag"># sync</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/dotnet-2019-11-02-state-sync-skill/" rel="prev" title="状态同步--技能系统的同步机制分析">
      <i class="fa fa-chevron-left"></i> 状态同步--技能系统的同步机制分析
    </a></div>
      <div class="post-nav-item">
    <a href="/unity-2019-11-15-unity-proxy/" rel="next" title="unity使用代理">
      unity使用代理 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="zhepama/igiven.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction-what-is-Quartz-NET"><span class="nav-number">1.</span> <span class="nav-text">Introduction - what is Quartz.NET?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Installing-Quartz-NET"><span class="nav-number">2.</span> <span class="nav-text">Installing Quartz.NET</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Creating-an-IJob"><span class="nav-number">3.</span> <span class="nav-text">Creating an IJob</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Creating-an-IJobFactory"><span class="nav-number">4.</span> <span class="nav-text">Creating an IJobFactory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Configuring-the-Job"><span class="nav-number">5.</span> <span class="nav-text">Configuring the Job</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Creating-the-QuartzHostedService"><span class="nav-number">6.</span> <span class="nav-text">Creating the QuartzHostedService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Using-scoped-services-in-jobs"><span class="nav-number">7.</span> <span class="nav-text">Using scoped services in jobs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary"><span class="nav-number">8.</span> <span class="nav-text">Summary</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Hangfire-与quartz-net对比"><span class="nav-number">8.1.</span> <span class="nav-text">Hangfire 与quartz.net对比</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="zhepama"
      src="https://secure.gravatar.com/avatar/0930091f05ac4d1044c02dbd3d619cfe?s=80&d=identicon&r=g">
  <p class="site-author-name" itemprop="name">zhepama</p>
  <div class="site-description" itemprop="description">一个不专业的程序员,写着专业的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zhepama" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhepama" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhepama@gmail.com" title="E-Mail → mailto:zhepama@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://www.godgodgame.com/" title="http:&#x2F;&#x2F;www.godgodgame.com" rel="noopener" target="_blank">GODGODGAME</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.igiven.com/" title="https:&#x2F;&#x2F;www.igiven.com">IGIVEN</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://zhepama.github.io/C-Sharp-Playground/zh/" title="https:&#x2F;&#x2F;zhepama.github.io&#x2F;C-Sharp-Playground&#x2F;zh&#x2F;" rel="noopener" target="_blank">数据结构与算法</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhepama</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
